# UAV × UGV 中控系統通訊協議說明

## 📡 通訊架構

```
載具（UAV/UGV） ←→ MAVLink 協議 ←→ 中控系統（Control Center）
```

本系統使用 **MAVLink 2.0** 協議進行通訊，支援 UDP 和 Serial（串列）兩種連接方式。

---

## 📤 載具提供給中控的資訊

載具需要通過 MAVLink 協議持續發送以下訊息給中控系統：

### 1. **HEARTBEAT（心跳包）**
**頻率**：1-10 Hz（建議 1 Hz）

**內容**：
- `base_mode`：基礎模式標誌（包含武裝狀態）
- `custom_mode`：自定義模式（飛行模式代碼）
- `system_status`：系統狀態
- `mavlink_version`：MAVLink 版本

**用途**：
- 中控判斷載具是否在線
- 獲取武裝狀態（`armed`）
- 獲取當前飛行模式（`mode`）

**範例**：
```python
# 中控解析後得到：
{
    "armed": True,
    "mode": "GUIDED",
    "system_status": "ACTIVE"
}
```

---

### 2. **ATTITUDE（姿態數據）**
**頻率**：10-50 Hz（建議 20 Hz）

**內容**：
- `roll`：橫滾角（弧度）
- `pitch`：俯仰角（弧度）
- `yaw`：偏航角（弧度）
- `rollspeed`：橫滾角速度（弧度/秒）
- `pitchspeed`：俯仰角速度（弧度/秒）
- `yawspeed`：偏航角速度（弧度/秒）
- `time_boot_ms`：開機時間戳（毫秒）

**用途**：
- 顯示姿態指示器（人工地平線）
- 性能圖表中的姿態歷史數據
- 計算載具朝向

**範例**：
```python
# 中控解析後得到：
{
    "attitude": {
        "rollDeg": -2.3,    # 度
        "pitchDeg": 1.1,    # 度
        "yawDeg": 180.0     # 度
    }
}
```

---

### 3. **VFR_HUD（飛行抬頭顯示數據）**
**頻率**：5-10 Hz（建議 10 Hz）

**內容**：
- `airspeed`：空速（m/s）
- `groundspeed`：地面速度（m/s）
- `heading`：航向（度，0-360）
- `throttle`：油門百分比（0-100）
- `alt`：高度（米）
- `climb`：爬升率（m/s）

**用途**：
- 顯示速度資訊
- 性能圖表中的運動數據
- 計算續航時間

**範例**：
```python
# 中控解析後得到：
{
    "motion": {
        "groundSpeed": 3.2,      # m/s
        "verticalSpeed": -0.3,    # m/s
        "heading": 180.0          # 度
    }
}
```

---

### 4. **GLOBAL_POSITION_INT（全球位置數據）**
**頻率**：5-10 Hz（建議 10 Hz）

**內容**：
- `lat`：緯度（度 × 1e7）
- `lon`：經度（度 × 1e7）
- `alt`：高度（毫米）
- `relative_alt`：相對高度（毫米）
- `vx`：X 方向速度（cm/s）
- `vy`：Y 方向速度（cm/s）
- `vz`：Z 方向速度（cm/s）
- `hdg`：航向（度 × 100）

**用途**：
- 地圖上顯示載具位置
- 記錄航跡
- 計算距離和導航

**範例**：
```python
# 中控解析後得到：
{
    "position": {
        "lat": 23.024087,
        "lon": 120.224649,
        "altitude": 13.2          # 米
    }
}
```

---

### 5. **SYS_STATUS（系統狀態）**
**頻率**：1-5 Hz（建議 2 Hz）

**內容**：
- `voltage_battery`：電池電壓（mV）
- `current_battery`：電池電流（cA，centiAmpere）
- `battery_remaining`：電池剩餘百分比（-1 表示未知）
- `load`：系統負載（%）
- `onboard_control_sensors_present`：感測器存在標誌
- `onboard_control_sensors_enabled`：感測器啟用標誌
- `onboard_control_sensors_health`：感測器健康狀態

**用途**：
- 顯示電池狀態
- 系統健康監控
- 計算剩餘續航時間

**範例**：
```python
# 中控解析後得到：
{
    "battery": {
        "voltage": 15.4,          # 伏特
        "current": 2.5,          # 安培
        "percent": 78             # 百分比
    },
    "systemHealth": {
        "cpu": 35,                # 系統負載百分比
        "memory": 40,
        "temperature": 55
    }
}
```

---

### 6. **BATTERY_STATUS（電池詳細狀態）**
**頻率**：1-2 Hz（建議 1 Hz）

**內容**：
- `id`：電池 ID
- `battery_function`：電池功能
- `type`：電池類型
- `temperature`：溫度（°C × 100）
- `voltages`：各電池電壓（mV）
- `current_battery`：電流（cA）
- `current_consumed`：已消耗容量（mAh）
- `energy_consumed`：已消耗能量（hJ）
- `battery_remaining`：剩餘百分比

**用途**：
- 更精確的電池監控
- 充電狀態判斷
- 電池健康評估

---

### 7. **RC_CHANNELS（遙控器通道數據）**
**頻率**：10-50 Hz（建議 20 Hz）

**內容**：
- `chan1_raw` ~ `chan18_raw`：18 個通道的原始值（PWM，1000-2000）
- `rssi`：信號強度（0-255）
- `time_boot_ms`：開機時間戳

**用途**：
- 顯示遙控器輸入
- 性能圖表中的 RC 輸入歷史
- 判斷手動/自動模式

**範例**：
```python
# 中控解析後得到：
{
    "rc": {
        "throttle": 0.55,    # 正規化到 -1 到 1
        "roll": 0.02,
        "pitch": -0.10,
        "yaw": 0.00
    }
}
```

---

### 8. **SERVO_OUTPUT_RAW（舵機輸出數據）**
**頻率**：10-50 Hz（建議 20 Hz）

**內容**：
- `servo1_raw` ~ `servo16_raw`：16 個舵機輸出值（PWM，1000-2000）
- `time_usec`：時間戳（微秒）

**用途**：
- 監控實際執行器輸出
- 驗證控制命令是否執行
- 故障診斷

---

### 9. **GPS_RAW_INT（GPS 原始數據）**
**頻率**：1-5 Hz（建議 1 Hz）

**內容**：
- `fix_type`：GPS 定位類型（0=無定位，1=無GPS，2=2D，3=3D，4=差分GPS，5=RTK浮點，6=RTK固定）
- `lat`：緯度（度 × 1e7）
- `lon`：經度（度 × 1e7）
- `alt`：高度（毫米）
- `eph`：水平位置精度（cm）
- `epv`：垂直位置精度（cm）
- `vel`：速度（cm/s）
- `cog`：航向（度 × 100）
- `satellites_visible`：可見衛星數
- `hdop`：水平精度因子

**用途**：
- GPS 狀態監控
- 定位品質評估
- 系統健康評分

**範例**：
```python
# 中控解析後得到：
{
    "gps": {
        "fix": 3,                # 3D 定位
        "satellites": 14,        # 14 顆衛星
        "hdop": 0.7              # 水平精度因子
    }
}
```

---

### 10. **STATUSTEXT（狀態文本訊息）**
**頻率**：事件觸發

**內容**：
- `severity`：嚴重程度（0=EMERGENCY，1=ALERT，2=CRITICAL，3=ERROR，4=WARNING，5=NOTICE，6=INFO，7=DEBUG）
- `text`：狀態文本（最多 50 字元）

**用途**：
- 訊息中心顯示
- 系統日誌記錄
- 錯誤和警告通知

**範例**：
```python
# 中控解析後得到：
{
    "timestamp": 1732000000,
    "level": "warning",
    "message": "Low battery: 20% remaining"
}
```

---

### 11. **EKF_STATUS_REPORT（EKF 狀態報告）**
**頻率**：1-2 Hz（建議 1 Hz）

**內容**：
- `flags`：EKF 狀態標誌
- `velocity_variance`：速度方差
- `pos_horiz_variance`：水平位置方差
- `pos_vert_variance`：垂直位置方差
- `compass_variance`：羅盤方差
- `terrain_alt_variance`：地形高度方差

**用途**：
- 導航系統健康監控
- 定位精度評估
- 故障診斷

---

## 📥 中控發送給載具的資訊

中控系統通過 MAVLink 協議發送以下命令給載具：

### 1. **HEARTBEAT（中控心跳包）**
**頻率**：1 Hz

**內容**：
- `type`：`MAV_TYPE_GCS`（地面控制站）
- `autopilot`：`MAV_AUTOPILOT_INVALID`
- `base_mode`：0
- `custom_mode`：0
- `system_status`：`MAV_STATE_ACTIVE`

**用途**：
- 告知載具中控系統在線
- 維持通訊連接
- 識別中控身份

---

### 2. **SET_MODE（設置飛行模式）**
**觸發**：用戶操作或自動任務

**內容**：
- `target_system`：目標系統 ID
- `base_mode`：基礎模式（通常為 1，表示啟用自定義模式）
- `custom_mode`：自定義模式代碼

**支援的模式**（Rover）：
- `0`：MANUAL（手動）
- `3`：STEERING（轉向）
- `4`：HOLD（保持）
- `5`：LOITER（盤旋）
- `6`：FOLLOW（跟隨）
- `10`：AUTO（自動）
- `11`：RTL（返航）
- `15`：GUIDED（引導）

**用途**：
- 切換載具飛行模式
- 執行自動任務
- 緊急模式切換

**範例**：
```python
# 中控發送：
POST /api/control/UGV1/mode
{
    "mode": "GUIDED"
}
```

---

### 3. **COMMAND_LONG（長命令）**
**觸發**：用戶操作或系統自動

**常用命令**：

#### 3.1 **武裝/解除武裝**
- `command`：`400`（`MAV_CMD_COMPONENT_ARM_DISARM`）
- `param1`：`1`（武裝）或 `0`（解除武裝）
- `param2`：`0`（無強制）

**範例**：
```python
# 中控發送：
POST /api/control/UGV1/arm
{
    "arm": True
}
```

#### 3.2 **返航（RTL）**
- `command`：`20`（`MAV_CMD_NAV_RETURN_TO_LAUNCH`）

#### 3.3 **設置 Home Point**
- `command`：`179`（`MAV_CMD_DO_SET_HOME`）
- `param1`：`1`（使用當前位置）
- `param5`：緯度
- `param6`：經度
- `param7`：高度

#### 3.4 **緊急停止**
- `command`：`176`（`MAV_CMD_DO_MOTOR_TEST`）
- 或切換到 `HOLD` 模式

---

### 4. **RC_CHANNELS_OVERRIDE（RC 通道覆蓋）**
**頻率**：10-50 Hz（持續控制時）

**內容**：
- `target_system`：目標系統 ID
- `target_component`：目標組件 ID
- `chan1_raw` ~ `chan18_raw`：18 個通道的 PWM 值（1000-2000，0 表示不覆蓋）

**用途**：
- 手動遙控載具（RC Override）
- 精確控制油門和轉向
- 緊急手動介入

**安全機制**：
- 需要持續發送（每 0.5 秒）以維持控制
- 超時自動清除（預設 5 秒）
- 緊急停止時禁止覆蓋

**範例**：
```python
# 中控發送（通過 RoverController）：
rover_controller.set_rover_movement(
    throttle_percent=50,    # 50% 油門
    steering_percent=-20   # 左轉 20%
)
```

---

### 5. **PARAM_SET（參數設置）**
**觸發**：用戶修改參數

**內容**：
- `target_system`：目標系統 ID
- `target_component`：目標組件 ID
- `param_id`：參數名稱（字串，最多 16 字元）
- `param_value`：參數值（浮點數）
- `param_type`：參數類型（`MAV_PARAM_TYPE_REAL32` 等）

**用途**：
- 調整飛控參數
- 配置載具行為
- 校準感測器

---

### 6. **MISSION 相關命令**
**觸發**：任務規劃和執行

#### 6.1 **MISSION_COUNT（任務計數）**
- 發送任務航點數量

#### 6.2 **MISSION_ITEM（任務項目）**
- 發送單個航點資訊（位置、高度、速度等）

#### 6.3 **MISSION_START（開始任務）**
- 開始執行已上傳的任務

#### 6.4 **MISSION_CLEAR（清除任務）**
- 清除所有任務航點

---

## 📊 數據頻率建議

| 訊息類型 | 建議頻率 | 最小頻率 | 最大頻率 |
|---------|---------|---------|---------|
| HEARTBEAT | 1 Hz | 0.5 Hz | 10 Hz |
| ATTITUDE | 20 Hz | 10 Hz | 50 Hz |
| VFR_HUD | 10 Hz | 5 Hz | 20 Hz |
| GLOBAL_POSITION_INT | 10 Hz | 5 Hz | 20 Hz |
| SYS_STATUS | 2 Hz | 1 Hz | 5 Hz |
| BATTERY_STATUS | 1 Hz | 0.5 Hz | 2 Hz |
| RC_CHANNELS | 20 Hz | 10 Hz | 50 Hz |
| SERVO_OUTPUT_RAW | 20 Hz | 10 Hz | 50 Hz |
| GPS_RAW_INT | 1 Hz | 0.5 Hz | 5 Hz |
| STATUSTEXT | 事件觸發 | - | - |
| EKF_STATUS_REPORT | 1 Hz | 0.5 Hz | 2 Hz |

---

## 🔒 安全機制

### 1. **連接健康監控**
- 中控持續監控 Heartbeat 頻率
- 檢測數據延遲和封包遺失
- 超過 2 秒未收到數據標記為「數據過時」

### 2. **RC Override 安全**
- 需要持續發送以維持控制（每 0.5 秒）
- 預設 5 秒超時自動清除
- 緊急停止狀態下禁止覆蓋

### 3. **命令驗證**
- 所有命令發送前檢查連接狀態
- 武裝命令需要滿足安全條件
- 模式切換前驗證模式有效性

### 4. **數據範圍限制**
- RC Override 值限制在 1000-2000（PWM）
- 參數設置前驗證範圍
- 位置命令檢查地理邊界

---

## 📝 數據格式轉換

### 角度轉換
```python
# 弧度 → 度
roll_deg = math.degrees(roll_rad)
pitch_deg = math.degrees(pitch_rad)
yaw_deg = math.degrees(yaw_rad)
```

### 位置轉換
```python
# MAVLink 格式（度 × 1e7）→ 標準格式（度）
latitude = msg.lat / 1e7
longitude = msg.lon / 1e7

# 高度（毫米）→ 米
altitude = msg.alt / 1000.0
```

### RC 通道轉換
```python
# PWM (1000-2000) → 正規化 (-1 到 1)
normalized = (pwm - 1500) / 500.0

# 百分比 (-100 到 100) → PWM
pwm = int(1500 + percent * 5)
```

### 電池數據轉換
```python
# 電壓（毫伏）→ 伏特
voltage = msg.voltage_battery / 1000.0

# 電流（厘安）→ 安培
current = msg.current_battery / 100.0
```

---

## 🔗 相關文件

- [MAVLink 官方文檔](https://mavlink.io/)
- [ArduPilot 開發者指南](https://ardupilot.org/dev/)
- [專案 README](./README.md)

---

## 📞 技術支援

如有通訊協議相關問題，請參考：
1. 系統日誌（`program/logs/`）
2. MAVLink 連接狀態（系統與電源頁面）
3. GitHub Issues

---

**版本**：v1.0  
**最後更新**：2025-01-XX

